package me.yourname.stalkeremission;

import org.bukkit.*;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;
import org.bukkit.scheduler.BukkitRunnable;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.Random;

public class StalkerEmission extends JavaPlugin {

    private boolean emissionActive = false;
    private Random random = new Random();
    private BukkitRunnable emissionTask;

    @Override
    public void onEnable() {
        getLogger().info("Плагин Выброс из Сталкера активирован!");

        // Запуск выбросов каждые 30 минут (настроите по желанию)
        new BukkitRunnable() {
            @Override
            public void run() {
                if (!emissionActive) {
                    startEmission();
                }
            }
        }.runTaskTimer(this, 36000L, 36000L); // 30 минут = 36000 ticks
    }

    @Override
    public boolean onCommand(CommandSender sender, Command cmd, String label, String[] args) {
        if (cmd.getName().equalsIgnoreCase("emissiontest")) {
            if (!emissionActive) {
                startEmission();
                sender.sendMessage(ChatColor.RED + "Тестовый выброс запущен!");
            } else {
                sender.sendMessage(ChatColor.YELLOW + "Выброс уже активен!");
            }
            return true;
        }
        
        if (cmd.getName().equalsIgnoreCase("emissionstop")) {
            if (emissionActive) {
                endEmission();
                sender.sendMessage(ChatColor.GREEN + "Выброс принудительно остановлен!");
            } else {
                sender.sendMessage(ChatColor.YELLOW + "Нет активных выбросов для остановки.");
            }
            return true;
        }
        return false;
    }

    public void startEmission() {
        if (emissionActive) return;
        
        emissionActive = true;
        getLogger().info("НАЧИНАЕТСЯ ВЫБРОС!");

        // Оповещение всем игрокам
        for (Player player : Bukkit.getOnlinePlayers()) {
            player.sendTitle(ChatColor.DARK_RED + "ВНИМАНИЕ!", ChatColor.RED + "Начинается выброс!", 10, 70, 20);
            player.playSound(player.getLocation(), Sound.ENTITY_LIGHTNING_THUNDER, 1.0f, 0.5f);
        }

        emissionTask = new BukkitRunnable() {
            int counter = 0;

            @Override
            public void run() {
                // Завершение выброса через 2 минуты
                if (counter++ >= 2400) { // 120 секунд = 2400 ticks
                    endEmission();
                    this.cancel();
                    return;
                }

                // Применение эффектов ко всем игрокам
                for (Player player : Bukkit.getOnlinePlayers()) {
                    // Эффекты для игрока
                    player.addPotionEffect(new PotionEffect(PotionEffectType.POISON, 100, 0));
                    player.addPotionEffect(new PotionEffect(PotionEffectType.BLINDNESS, 100, 0));
                    player.addPotionEffect(new PotionEffect(PotionEffectType.SLOW, 100, 1));

                    // Частицы радиации вокруг игрока
                    player.getWorld().spawnParticle(Particle.REDSTONE, player.getLocation(), 50, 
                            new Particle.DustOptions(Color.fromRGB(0, 255, 0), 1));

                    // Случайные молнии вокруг игрока
                    if (random.nextInt(100) < 10) {
                        Location loc = player.getLocation().add(
                            random.nextInt(20) - 10,
                            0,
                            random.nextInt(20) - 10
                        );
                        player.getWorld().strikeLightningEffect(loc);
                    }

                    // Случайные аномалии (взрывы)
                    if (random.nextInt(100) < 5) {
                        Location anomalyLoc = player.getLocation().add(
                            random.nextInt(30) - 15,
                            0,
                            random.nextInt(30) - 15
                        );
                        player.getWorld().createExplosion(anomalyLoc, 3.0f, false);
                    }
                }
            }
        };
        
        emissionTask.runTaskTimer(this, 0L, 1L);
    }

    public void endEmission() {
        if (!emissionActive) return;
        
        emissionActive = false;
        if (emissionTask != null) {
            emissionTask.cancel();
        }
        getLogger().info("Выброс закончился.");

        for (Player player : Bukkit.getOnlinePlayers()) {
            player.sendTitle(ChatColor.GREEN + "ВЫБРОС ЗАКОНЧИЛСЯ", 
                            ChatColor.YELLOW + "Радиационный фон нормализовался", 
                            10, 70, 20);
            player.playSound(player.getLocation(), Sound.BLOCK_BELL_USE, 1.0f, 1.0f);
            
            // Удаляем негативные эффекты
            player.removePotionEffect(PotionEffectType.POISON);
            player.removePotionEffect(PotionEffectType.BLINDNESS);
            player.removePotionEffect(PotionEffectType.SLOW);
        }
    }

    @Override
    public void onDisable() {
        if (emissionActive) {
            endEmission();
        }
        getLogger().info("Плагин Выброс из Сталкера деактивирован!");
    }
}
